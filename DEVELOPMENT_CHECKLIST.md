# 開発・テストチェックリスト

このドキュメントは、今回の「テストは通るが実際の操作でエラー」問題を防ぐためのチェックリストです。

## 新機能開発時のチェックリスト

### 1. 実装前の準備
- [ ] 影響範囲の全体把握（フロントエンド→バックエンド→データベース）
- [ ] 関連するデータベーススキーマの確認
- [ ] 既存の類似機能との統合ポイント特定

### 2. 実装中のチェック
- [ ] 単体テストの作成
- [ ] データベーススキーマ変更が必要な場合の全テーブル確認
- [ ] 認証・認可に関わる場合のユーザー情報フロー確認

### 3. 実装後の検証（必須）

#### Level 1: 単体テスト
```bash
npm test                    # 全単体テスト
npm run test:degradation    # デグレード防止テスト
```

#### Level 2: 統合テスト
```bash
npm run test:e2e           # エンドツーエンドテスト
```

#### Level 3: 手動確認（最重要）
1. **フロントエンドからの実際操作**
   - [ ] 実際のブラウザでログイン
   - [ ] 該当機能の操作実行
   - [ ] 正常系・異常系の両方確認

2. **ログ確認**
   - [ ] `docker compose logs -f backend` でリアルタイムログ確認
   - [ ] エラーログがないことを確認
   - [ ] 期待されるログメッセージの表示確認

3. **データベース確認**
   - [ ] 予想されるデータが正しく挿入されているか
   - [ ] 制約違反が発生していないか

## データベーススキーマ変更時の特別チェック

### 必須確認事項
1. **テーブル構造確認**
   ```sql
   \d table_name  -- テーブル構造確認
   ```

2. **NOT NULL制約確認**
   - [ ] INSERT文で全ての必須カラムに値を渡しているか
   - [ ] 新しく追加したNOT NULLカラムの影響確認

3. **外部キー制約確認**
   - [ ] 参照先テーブルの値が存在するか
   - [ ] カラム名の変更（例: `created_by` → `created_by_uuid`）の影響確認

## 今回の問題の教訓

### 問題パターン
- **テスト**: 既存API直接呼び出し → ✅ 通る
- **実際操作**: フロントエンド → API → データベース → ❌ エラー

### 根本原因
1. **テスト範囲の不一致**: 新機能のテストと実際のエラー箇所が違う
2. **統合テストの不足**: エンドツーエンドフローのテスト不足
3. **データベーススキーマ確認の不足**: INSERT文とテーブル構造の不整合

### 予防策
1. **必ず実際操作での確認**: テストが通っても必ず手動で確認
2. **エンドツーエンドテストの充実**: ユーザー操作をシミュレート
3. **データベース変更時のチェック強化**: スキーマとクエリの整合性確認

## 緊急時の対応フロー

### エラー発生時
1. **即座にログ確認**
   ```bash
   docker compose logs -f backend | grep -i error
   ```

2. **データベース状態確認**
   ```bash
   docker compose exec db psql -U postgres -d ai_agent_dev
   ```

3. **フロントエンド・バックエンド別々に確認**
   - フロントエンド: ブラウザ開発者ツール
   - バックエンド: API直接呼び出し

### デバッグ優先順位
1. **データベーススキーマエラー**（最優先）
2. **認証・認可エラー**
3. **ビジネスロジックエラー**
4. **パフォーマンス問題**

## 定期的なヘルスチェック

### 週次実行
```bash
npm run test:e2e          # エンドツーエンド確認
npm run test:degradation  # デグレード確認
```

### 新機能リリース前
```bash
npm run test:ci           # 全テスト実行
# + 手動でのフロントエンド操作確認（必須）
```

この チェックリストを活用して、「テストは通るが実際にはエラー」という問題を予防しましょう。