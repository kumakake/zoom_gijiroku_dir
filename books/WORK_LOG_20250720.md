# 作業ログ 2025年7月20日

## 概要
本番環境でのRedis接続エラーとキュー状態取得問題の修正作業

## 問題の発生

### 初期症状
- デバッグダッシュボードでキュー状態表示エラー
- "エンドポイントが見つかりません"エラー（一部テスト項目）
- 本番環境でのみ発生、開発環境では正常動作

### エラー内容
```
getaddrinfo EAI_AGAIN redis
MaxRetriesPerRequestError: Reached the max retries per request limit
Stream isn't writeable and enableOfflineQueue options is false
Connection is closed.
```

## 根本原因の分析

### 1. 環境構成の違い
- **開発環境**: Docker Compose（`redis`ホスト名でアクセス）
- **本番環境**: PM2管理、実サーバー上のRedis（`localhost`でアクセス）

### 2. Redis設定の問題
- コードが開発環境用の`host: 'redis'`をデフォルト値として使用
- PM2のecosystem.config.jsで設定された`REDIS_URL`が正しく使用されていない
- Redis URL形式の不備

### 3. 接続管理の問題
- キュー接続のキャッシュ機能が本番環境で不安定
- 接続のライフサイクル管理が不適切

## 解決過程

### Phase 1: 問題特定と診断機能追加
- Redis接続テスト関数の実装
- フォールバック機能の追加（Redis接続失敗時でもUI表示）
- Redis診断エンドポイントの追加

### Phase 2: Redis設定の修正
- `REDIS_URL`優先使用への変更
- 開発環境（Docker）と本番環境（PM2）の設定分岐
- 接続パラメータの最適化

### Phase 3: Redis URL形式の修正
#### 試行錯誤の履歴
1. **初期**: `redis://:password@localhost:6379` → DNS解決エラー
2. **分離方式**: `REDIS_URL: redis://localhost:6379` + `REDIS_PASSWORD` → 複雑化
3. **最終解決**: `redis://default:password@localhost:6379` → 成功

### Phase 4: 接続ライフサイクル管理の改善
- キューキャッシュの廃止
- 毎回新しいキュー接続作成
- 適切な接続クローズ処理の実装

## 最終的な修正内容

### 1. ecosystem.config.js（本番環境設定）
```javascript
// 修正前
REDIS_URL: 'redis://:d703a7f5419e0c207afcbb98b73b0dd23d40d555a7500296a8c29f99217fa439@localhost:6379',
REDIS_PASSWORD: 'd703a7f5419e0c207afcbb98b73b0dd23d40d555a7500296a8c29f99217fa439',

// 修正後
REDIS_URL: 'redis://default:d703a7f5419e0c207afcbb98b73b0dd23d40d555a7500296a8c29f99217fa439@localhost:6379',
```

### 2. backend/routes/debug.js
#### Redis設定の環境別分岐
```javascript
if (process.env.REDIS_URL) {
    // 本番環境（PM2）: REDIS_URL使用
    redisConfig = process.env.REDIS_URL;
} else {
    // 開発環境（Docker）: 個別設定使用
    redisConfig = { redis: { host: 'redis', ... } };
}
```

#### キュー接続管理の改善
```javascript
// 修正前: キャッシュ使用
const transcriptQueue = await getOrCreateQueue('transcript');

// 修正後: 毎回新規作成＋適切なクローズ
try {
    const transcriptQueue = createQueue('transcript');
    // キュー操作...
} finally {
    await transcriptQueue.close();
}
```

### 3. 接続設定の最適化
```javascript
redis: {
    maxRetriesPerRequest: 3,
    retryDelayOnFailover: 1000,
    enableReadyCheck: true,
    connectTimeout: 15000,
    commandTimeout: 8000,
    lazyConnect: false,
    enableOfflineQueue: true,  // 重要: falseだとエラー
    keepAlive: 30000,
    family: 4
}
```

## 技術的な学び

### 1. 環境構成の重要性
- 開発環境（Docker）と本番環境（PM2）の違いを明確に分離
- 環境変数による設定の一元管理の重要性

### 2. Redis接続管理
- ioredisライブラリの設定パラメータの理解
- 接続プールとライフサイクル管理の重要性
- `enableOfflineQueue`設定の影響

### 3. デバッグ手法
- 段階的な問題切り分け
- フォールバック機能による可用性確保
- 診断エンドポイントによる運用性向上

## 追加された機能

### 1. Redis診断機能
- デバッグページに「🩺 Redis診断」ボタン追加
- 接続状態、応答時間、読み書きテストの実行
- 環境設定情報の表示

### 2. フォールバック機能
- Redis接続失敗時でもキュー画面表示
- エラー時の適切なメッセージ表示
- ユーザーエクスペリエンスの向上

### 3. 改善されたエラーハンドリング
- 詳細なエラーログ出力
- 段階的なタイムアウト設定
- 適切な接続クリーンアップ

## 結果

✅ **本番環境でキュー状態が正常表示**
✅ **Redis接続エラーの完全解消**  
✅ **開発環境との互換性維持**
✅ **運用性とデバッグ機能の向上**

## 今後の改善点

1. **監視機能の追加**: Redis接続状態の継続監視
2. **アラート機能**: 接続問題の早期検知
3. **パフォーマンス最適化**: 接続プールサイズの調整
4. **ドキュメント整備**: トラブルシューティングガイドの作成

## ファイル変更履歴

### 修正されたファイル
- `backend/routes/debug.js` - Redis接続とキュー管理の大幅改修
- `ecosystem.config.js` - REDIS_URL形式の修正
- `frontend/src/pages/DebugPage.tsx` - 診断機能とエラーハンドリング追加
- `frontend/src/lib/api.ts` - タイムアウト設定追加

### 追加された機能
- Redis診断エンドポイント (`/api/debug/redis-diagnosis`)
- フォールバック表示機能
- 改善されたエラーメッセージ表示

## 備考

この修正により、本番環境でのRedis接続問題が根本的に解決され、デバッグダッシュボードが正常に動作するようになった。PM2による環境変数管理とRedis接続の適切な設定により、運用の安定性が大幅に向上した。