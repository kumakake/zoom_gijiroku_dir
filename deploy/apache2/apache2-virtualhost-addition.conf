# 既存のtools.cross-astem.jpのVirtualHostに追加する設定
# 既存の"###ここまで###"の直前に以下を追加してください

# -- Zoom議事録自動配布システム
    # バックエンドAPI
    ProxyPass /zm/api/            http://localhost:8000/api/
    ProxyPassReverse /zm/api/     http://localhost:8000/api/
    
    # フロントエンド（Next.js）
    ProxyPass /zm/               http://localhost:3000/zm/
    ProxyPassReverse /zm/         http://localhost:3000/zm/

    # Zoom Webhook専用設定（タイムアウト延長）
    <Location "/zm/api/webhooks/zoom">
        ProxyPass http://localhost:8000/api/webhooks/zoom
        ProxyPassReverse http://localhost:8000/api/webhooks/zoom
        ProxyTimeout 300
        # Zoom Webhookの大きなペイロードに対応
        LimitRequestBody 10485760
    </Location>

    # 音声アップロード専用設定（大きなファイル対応）
    <Location "/zm/api/upload/audio">
        ProxyPass http://localhost:8000/api/upload/audio
        ProxyPassReverse http://localhost:8000/api/upload/audio
        ProxyTimeout 600
        # 100MB制限
        LimitRequestBody 104857600
    </Location>

    # セキュリティヘッダー（Zoom議事録システム用）
    <LocationMatch "^/zm/">
        Header always set X-Frame-Options "SAMEORIGIN"
        Header always set X-Content-Type-Options "nosniff"
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
        Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
        
        # CORS設定（本番環境）
        Header always set Access-Control-Allow-Origin "https://tools.cross-astem.jp"
        Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
        Header always set Access-Control-Allow-Credentials "true"
    </LocationMatch>

    # Next.js用SPAリライトルール
    <Directory "/zm">
        RewriteEngine On
        RewriteBase /zm/
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /zm/index.html [L]
    </Directory>