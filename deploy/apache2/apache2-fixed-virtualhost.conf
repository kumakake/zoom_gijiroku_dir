# Apache2 VirtualHost設定 - Zoom議事録自動配布システム
# エラー修正版: ProxyPass個別設定で適切なタイムアウト値を指定

<VirtualHost *:443>
    ServerName tools.cross-astem.jp
    DocumentRoot /var/www/html
    
    # SSL設定
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/tools.cross-astem.jp/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/tools.cross-astem.jp/privkey.pem
    
    # プロキシ基本設定
    ProxyPreserveHost On
    ProxyBadHeader Ignore
    
    # 個別ProxyPass設定（処理特性に応じたタイムアウト値）
    
    # Zoom Webhook（5分・軽量処理）
    ProxyPass /zm/api/webhooks/zoom http://localhost:3020/api/webhooks/zoom timeout=300
    ProxyPassReverse /zm/api/webhooks/zoom http://localhost:3020/api/webhooks/zoom
    
    # 音声アップロード（10分・重い処理）
    ProxyPass /zm/api/upload/audio http://localhost:3020/api/upload/audio timeout=600
    ProxyPassReverse /zm/api/upload/audio http://localhost:3020/api/upload/audio
    
    # デバッグAPI（統合フローテスト用・5分）
    ProxyPass /zm/api/debug/test-full-flow http://localhost:3020/api/debug/test-full-flow timeout=300
    ProxyPassReverse /zm/api/debug/test-full-flow http://localhost:3020/api/debug/test-full-flow
    
    # その他のAPI（1分・一般的な処理）
    ProxyPass /zm/api/ http://localhost:3020/api/ timeout=60
    ProxyPassReverse /zm/api/ http://localhost:3020/api/
    
    # フロントエンド（Next.js）
    ProxyPass /zm/ http://localhost:3021/zm/
    ProxyPassReverse /zm/ http://localhost:3021/zm/
    
    # Location設定（リクエストサイズ制限・セキュリティヘッダー）
    
    # Zoom Webhook専用設定
    <Location "/zm/api/webhooks/zoom">
        LimitRequestBody 10485760
        Header always set Access-Control-Allow-Origin "https://tools.cross-astem.jp"
        Header always set Access-Control-Allow-Methods "POST, OPTIONS"
        Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Zoom-Webhook-Signature"
    </Location>
    
    # 音声アップロード専用設定（大きなファイル対応）
    <Location "/zm/api/upload/audio">
        LimitRequestBody 104857600
        Header always set Access-Control-Allow-Origin "https://tools.cross-astem.jp"
        Header always set Access-Control-Allow-Methods "POST, OPTIONS"
        Header always set Access-Control-Allow-Headers "Content-Type, Authorization"
    </Location>
    
    # デバッグAPI設定（開発・テスト用）
    <Location "/zm/api/debug/">
        LimitRequestBody 10485760
        Header always set Access-Control-Allow-Origin "https://tools.cross-astem.jp"
        Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS"
        Header always set Access-Control-Allow-Headers "Content-Type, Authorization"
    </Location>
    
    # 一般的なAPI設定
    <Location "/zm/api/">
        Header always set Access-Control-Allow-Origin "https://tools.cross-astem.jp"
        Header always set Access-Control-Allow-Credentials "true"
        Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Header always set Access-Control-Allow-Headers "Content-Type, Authorization"
    </Location>
    
    # フロントエンド設定
    <Location "/zm/">
        Header always set X-Frame-Options "SAMEORIGIN"
        Header always set X-Content-Type-Options "nosniff"
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
    </Location>
    
    # セキュリティヘッダー（全体）
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https:; frame-ancestors 'none';"
    
    # ログ設定
    ErrorLog ${APACHE_LOG_DIR}/tools.cross-astem.jp_error.log
    CustomLog ${APACHE_LOG_DIR}/tools.cross-astem.jp_access.log combined
    
    # 既存のサイト設定をここに追加
    # Include /etc/apache2/sites-available/tools.cross-astem.jp-existing.conf
</VirtualHost>

# HTTP to HTTPS リダイレクト
<VirtualHost *:80>
    ServerName tools.cross-astem.jp
    Redirect permanent / https://tools.cross-astem.jp/
</VirtualHost>

# 設定説明:
# - Zoom Webhook: 300秒（軽量なJSON処理）
# - 音声アップロード: 600秒（大容量ファイル + AI処理）
# - デバッグAPI: 300秒（統合フローテスト用）
# - その他API: 60秒（一般的な処理）
# - フロントエンド: デフォルト（静的コンテンツ）