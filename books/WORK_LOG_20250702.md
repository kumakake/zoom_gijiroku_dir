# AIエージェントサービス開発作業記録 - 2025年7月2日

## プロジェクト概要
AIエージェントサービス「Zoom議事録自動配布システム」のZoom認証方式更新作業記録。
JWT認証（非推奨）からServer-to-Server OAuth認証への移行作業。

## 実施した作業内容

### 1. Zoom認証方式の課題確認
- **問題**: 現在のコードがZoom JWT認証（非推奨）を使用
- **現状**: `ZOOM_API_KEY` + `ZOOM_API_SECRET` でClient Credentials方式
- **必要**: Server-to-Server OAuth方式への移行

### 2. Zoom認証実装の更新

#### 認証メソッドの修正
**ファイル**: `backend/workers/transcriptWorker.js`
- **対象メソッド**: `getZoomAccessToken()`
- **変更内容**:
  ```javascript
  // 変更前: Client Credentials方式
  const response = await axios.post('https://zoom.us/oauth/token', null, {
    params: { grant_type: 'client_credentials' },
    auth: {
      username: process.env.ZOOM_API_KEY,
      password: process.env.ZOOM_API_SECRET
    }
  });

  // 変更後: Server-to-Server OAuth方式
  const credentials = Buffer.from(`${process.env.ZOOM_CLIENT_ID}:${process.env.ZOOM_CLIENT_SECRET}`).toString('base64');
  const response = await axios.post('https://zoom.us/oauth/token', 
    `grant_type=account_credentials&account_id=${process.env.ZOOM_ACCOUNT_ID}`,
    {
      headers: {
        'Authorization': `Basic ${credentials}`,
        'Content-Type': 'application/x-www-form-urlencoded'
      }
    }
  );
  ```

### 3. 環境変数の更新

#### 開発環境設定の変更
**ファイル**: `.env.development`
```bash
# 変更前
ZOOM_API_KEY=your_zoom_api_key
ZOOM_API_SECRET=your_zoom_api_secret

# 変更後
ZOOM_ACCOUNT_ID=XnO_bZU3TWmobWvLuELShA
ZOOM_CLIENT_ID=uXAjpm3qQ2yBjnbiiTumXQ
ZOOM_CLIENT_SECRET=HgwFNOtV2gMdtv0ayFD2OzMhzoiB4a8N
ZOOM_WEBHOOK_SECRET=Y3hnetGORy6gKaBkoy8XzA
```

#### 環境変数テンプレートの更新
**ファイル**: `.env.example`
```bash
# ---------------------------
# Zoom API設定（Server-to-Server OAuth）
# ---------------------------
ZOOM_ACCOUNT_ID=your_zoom_account_id
ZOOM_CLIENT_ID=your_zoom_client_id
ZOOM_CLIENT_SECRET=your_zoom_client_secret
ZOOM_WEBHOOK_SECRET=your_zoom_webhook_secret
```

**ファイル**: `.env.production.example`
```bash
# ---------------------------
# Zoom API設定（本番・Server-to-Server OAuth）
# ---------------------------
ZOOM_ACCOUNT_ID=${ZOOM_ACCOUNT_ID}
ZOOM_CLIENT_ID=${ZOOM_CLIENT_ID}
ZOOM_CLIENT_SECRET=${ZOOM_CLIENT_SECRET}
ZOOM_WEBHOOK_SECRET=${ZOOM_WEBHOOK_SECRET}
```

### 4. Zoom Webhook設定の詳細確認

#### 必要なWebhookイベント
1. **`recording.completed`**（最重要）
   - 目的: 会議録画が完了したときに通知
   - 処理: 録画ファイルダウンロード→文字起こし→議事録生成→メール配布

2. **`meeting.ended`**（補助）
   - 目的: 会議が終了したときに通知
   - 処理: 会議終了の記録、録画開始の準備

#### Webhook詳細設定
**Event Subscriptions**:
- ☑️ `meeting.ended` - 会議終了通知
- ☑️ `recording.completed` - 録画完了通知（最重要）
  - **All Recordings have completed** - 全録画完了
  - **Recording Transcript files have completed** - 自動文字起こし完了
  - **推奨**: 両方チェック（冗長性確保）

**Webhook URL**:
- 開発環境: `https://your-ngrok-id.ngrok.io/api/webhooks/zoom`
- 本番環境: `https://tools.cross-astem.jp/zm/api/webhooks/zoom`

### 5. 必要なZoom API Scopes

#### 必須Scopes
- ☑️ **`recording:read`** - 録画情報の取得
- ☑️ **`cloud_recording:read`** - クラウド録画ファイルの取得
- ☑️ **`meeting:read`** - 会議情報の取得

#### 推奨Scopes（管理者権限）
- ☑️ **`recording:read:admin`** - 管理者レベルの録画情報取得
- ☑️ **`meeting:read:admin`** - 管理者レベルの会議情報取得
- ☑️ **`user:read`** - ユーザー情報の取得（参加者情報用）

#### Scopeの用途
| Scope | 用途 | 重要度 |
|-------|------|---------|
| `recording:read` | 録画メタデータ取得 | **必須** |
| `cloud_recording:read` | 録画ファイルダウンロード | **必須** |
| `meeting:read` | 会議情報取得 | **必須** |
| `recording:read:admin` | 全録画へのアクセス | 推奨 |
| `meeting:read:admin` | 全会議へのアクセス | 推奨 |
| `user:read` | 参加者情報取得 | 推奨 |

## 技術的な変更点

### 認証方式の比較
| 項目 | 旧方式（JWT） | 新方式（Server-to-Server OAuth） |
|------|---------------|-----------------------------------|
| 認証タイプ | JWT Token | OAuth 2.0 |
| 必要パラメータ | API Key + Secret | Account ID + Client ID + Secret |
| セキュリティ | 非推奨 | 推奨 |
| トークン有効期限 | 固定 | 1時間（自動更新） |
| APIエンドポイント | 同一 | 同一 |

### 実装上の変更点
1. **Base64エンコーディング**: Client IDとSecretをBase64でエンコード
2. **リクエスト形式**: URLエンコードされたボディでAccount ID送信
3. **ヘッダー設定**: `Authorization: Basic` + `Content-Type: application/x-www-form-urlencoded`
4. **エラーハンドリング**: レスポンス詳細ログ追加

## 完成した機能

### ✅ 更新完了項目
1. **Zoom認証実装の更新** - Server-to-Server OAuth方式
2. **環境変数の更新** - 開発・本番環境対応
3. **Webhook設定の詳細化** - 必要イベントとScopes特定
4. **認証フローの最適化** - エラーハンドリング強化

### 🔧 現在のシステム状態
- **認証方式**: Server-to-Server OAuth（最新・推奨）
- **必要情報**: Account ID、Client ID、Client Secret が設定済み
- **Webhook対応**: 録画完了・会議終了イベント処理可能
- **API権限**: 録画・会議・ユーザー情報取得権限

## 次のステップ

### 1. Zoom Marketplace設定
- Server-to-Server OAuthアプリの作成
- 必要Scopesの申請・承認
- Event Subscriptionsの設定
- Webhook URLの登録

### 2. 動作テスト
- ngrok環境でのWebhook受信テスト
- 録画完了イベントの処理確認
- AI議事録生成フローの動作確認
- メール配布機能の動作確認

### 3. 運用準備
- 本番環境への設定適用
- 監視・ログ設定の確認
- エラーハンドリングの動作確認

## 学習ポイント

### Zoom API認証の変化
- JWT認証の非推奨化とOAuth 2.0への移行
- Server-to-Server OAuth方式の実装方法
- 環境変数管理のベストプラクティス

### セキュリティ向上
- 認証情報の適切な管理
- API権限の最小化原則
- エラーログの詳細化

## 作業時間
- **開始時刻**: 2025年7月2日 15:00
- **完了時刻**: 2025年7月2日 16:00
- **作業時間**: 1時間

---

**作業者**: Claude Code  
**作業日**: 2025年7月2日  
**プロジェクト**: AIエージェントサービス - Zoom議事録自動配布システム  
**Phase**: Zoom認証方式更新完了