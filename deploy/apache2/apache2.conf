# AIエージェントサービス用Apache2設定
# 既存のtools.cross-astem.jpのVirtualHostに追加する設定

# Zoom議事録自動配布システム用設定
# パス: /zm

# -- Zoom議事録自動配布システム（フロントエンド）
ProxyPass /zm/api/            http://localhost:8000/api/
ProxyPassReverse /zm/api/     http://localhost:8000/api/
ProxyPass /zm/               http://localhost:3000/zm/
ProxyPassReverse /zm/         http://localhost:3000/zm/

# Zoom Webhook専用設定（タイムアウト延長）
<Location "/zm/api/webhooks/zoom">
    ProxyPass http://localhost:8000/api/webhooks/zoom
    ProxyPassReverse http://localhost:8000/api/webhooks/zoom
    ProxyTimeout 300
    # Zoom Webhookの大きなペイロードに対応
    LimitRequestBody 10485760
</Location>

# 音声アップロード専用設定（大きなファイル対応）
<Location "/zm/api/upload/audio">
    ProxyPass http://localhost:8000/api/upload/audio
    ProxyPassReverse http://localhost:8000/api/upload/audio
    ProxyTimeout 600
    # 100MB制限
    LimitRequestBody 104857600
</Location>

# フロントエンド用設定
<Location "/zm">
    # Next.jsアプリケーション用設定
    ProxyPreserveHost On
    ProxyAddHeaders On
    
    # プロキシヘッダーの設定
    ProxyPassReverse http://localhost:3000/zm/
    
    # WebSocketサポート（Next.js dev server用）
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/zm/(.*)$ "ws://localhost:3000/zm/$1" [P,L]
    
    # SPAのためのリライトルール
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^/zm/(.*)$ http://localhost:3000/zm/$1 [P,L]
</Location>

# セキュリティヘッダー
Header always set X-Frame-Options "SAMEORIGIN"
Header always set X-Content-Type-Options "nosniff"
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "strict-origin-when-cross-origin"
Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

# CORS設定（開発環境のみ）
<IfDefine DEVELOPMENT>
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
</IfDefine>

# 本番環境用CORS設定
<IfDefine PRODUCTION>
    Header always set Access-Control-Allow-Origin "https://tools.cross-astem.jp"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    Header always set Access-Control-Allow-Credentials "true"
</IfDefine>

# ログ設定
LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %D" ai_agent_combined
CustomLog ${APACHE_LOG_DIR}/ai-agent-access.log ai_agent_combined
ErrorLog ${APACHE_LOG_DIR}/ai-agent-error.log

# SSL設定（既存のSSL設定を継承）
# SSLEngine on
# SSLCertificateFile /etc/letsencrypt/live/tools.cross-astem.jp/fullchain.pem
# SSLCertificateKeyFile /etc/letsencrypt/live/tools.cross-astem.jp/privkey.pem